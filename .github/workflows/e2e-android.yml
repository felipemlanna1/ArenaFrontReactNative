name: E2E Tests - Android

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2am UTC
  workflow_dispatch:  # Manual trigger

jobs:
  e2e-android:
    runs-on: ubuntu-latest  # Free unlimited for public repos
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: ðŸ“š Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸŽ­ Install Maestro CLI
        run: |
          curl -fsSL https://get.maestro.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: âœ… Verify Maestro installation
        run: maestro --version

      - name: ðŸ“± Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ðŸ”§ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“ Create Maestro env file
        run: |
          cat > .maestro/maestro.env << 'EOF'
          TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL || 'test@arena.com' }}
          TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD || 'Test@123' }}
          BASE_URL=${{ secrets.TEST_BASE_URL || 'https://api.arena.dev' }}
          EOF

      - name: ðŸ—ï¸ Build Android App (Debug)
        run: |
          npx expo prebuild --platform android --clean
          cd android
          ./gradlew assembleDebug --no-daemon

      - name: ðŸ§ª Run Maestro E2E Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_5
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            echo "ðŸš€ Starting Maestro tests..."
            maestro test .maestro/flows/ \
              --format junit \
              --output maestro-android-report.xml \
              --env-file .maestro/maestro.env

      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-android-results
          path: |
            maestro-android-report.xml
            ~/.maestro/tests/**/*.png
            ~/.maestro/tests/**/*.mp4
            ~/.maestro/tests/**/*.log
          retention-days: 30

      - name: ðŸ“ˆ Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Maestro Android E2E Tests
          path: maestro-android-report.xml
          reporter: java-junit
          fail-on-error: true

      - name: ðŸ’¬ Comment on commit (if failed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `âŒ E2E Tests (Android) failed on commit ${context.sha.substring(0, 7)}

            Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            Screenshots and videos are available in the artifacts.`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: message
            });
