name: E2E Smoke Tests - PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**'
      - '.maestro/**'
      - 'app.json'
      - 'package.json'

jobs:
  smoke-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: ğŸ“š Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ­ Install Maestro CLI
        run: |
          curl -fsSL https://get.maestro.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: ğŸ“± Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸ“ Create Maestro env file
        run: |
          cat > .maestro/maestro.env << 'EOF'
          TEST_USER_EMAIL=${{ secrets.TEST_USER_EMAIL || 'test@arena.com' }}
          TEST_USER_PASSWORD=${{ secrets.TEST_USER_PASSWORD || 'Test@123' }}
          BASE_URL=${{ secrets.TEST_BASE_URL || 'https://api.arena.dev' }}
          EOF

      - name: ğŸ—ï¸ Build Android App (Debug)
        run: |
          npx expo prebuild --platform android --clean
          cd android
          ./gradlew assembleDebug --no-daemon

      - name: ğŸ§ª Run Smoke Tests (Login only)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_5
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            echo "ğŸ”¥ Running smoke tests (login)..."
            maestro test .maestro/flows/auth/login.yaml \
              --env-file .maestro/maestro.env

      - name: âœ… Comment on PR (success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `âœ… **E2E Smoke Tests Passed!**

            Login flow is working correctly on Android.

            **Next Steps:**
            - Full E2E suite will run on merge to main
            - Check artifacts for screenshots

            <sub>ğŸ¤– Generated by Maestro E2E Â· [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: âŒ Comment on PR (failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `âŒ **E2E Smoke Tests Failed**

            The login flow is broken on Android. Please check the test results.

            **Debugging:**
            1. Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details
            2. Download artifacts for screenshots/logs
            3. Run locally: \`maestro test .maestro/flows/auth/login.yaml\`

            <sub>ğŸ¤– Generated by Maestro E2E</sub>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

      - name: ğŸ“Š Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            ~/.maestro/tests/**/*.png
            ~/.maestro/tests/**/*.log
          retention-days: 7
